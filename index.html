<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOE Super Bowl Squares - Super Bowl LX</title>
    <style>
        :root {
            --bg-dark: #0a0e27;
            --bg-card: #141937;
            --gold: #c9a84c;
            --gold-light: #e8d48b;
            --silver: #b8c0d0;
            --text: #e8eaf0;
            --text-dim: #7a82a0;
            --border: #2a3060;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main-layout {
            display: flex;
            flex: 1;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
            padding: 0 10px;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .chat-sidebar {
            width: 350px;
            position: sticky;
            top: 10px;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }

        /* Hide chat tab on desktop, show sidebar */
        .tab-button-chat {
            display: none;
        }

        /* On smaller screens, hide sidebar and show chat tab */
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
            }
            .chat-sidebar {
                display: none !important;
            }
            .tab-button-chat {
                display: inline-block;
            }
            #tab-chat {
                display: none;
            }
            #tab-chat.active {
                display: block;
            }
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            text-align: center;
            padding: 30px 20px 10px;
            width: 100%;
            background: linear-gradient(180deg, #0f1535 0%, var(--bg-dark) 100%);
        }

        .header-logo {
            width: 220px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 12px rgba(201, 168, 76, 0.4));
        }

        .header h1 {
            font-size: 2.4rem;
            font-weight: 800;
            letter-spacing: 3px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: var(--text-dim);
            letter-spacing: 5px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .header .game-info {
            font-size: 1.05rem;
            color: var(--silver);
            margin-top: 4px;
        }

        .header .game-info .vs {
            color: var(--gold);
            font-weight: 700;
            margin: 0 10px;
        }

        .header .game-date {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* â”€â”€ Pot Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pot-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 14px 0 8px;
            flex-wrap: wrap;
        }

        .pot-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 24px;
            text-align: center;
        }

        .pot-item .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        .pot-item .value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--gold);
        }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 18px 0 6px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 28px;
            border: 2px solid var(--gold);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-shuffle {
            background: transparent;
            color: var(--gold);
        }

        .btn-shuffle:hover:not(:disabled) {
            background: var(--gold);
            color: var(--bg-dark);
        }

        .btn-lock {
            background: var(--accent-green);
            color: #fff;
            border-color: var(--accent-green);
        }

        .btn-lock:hover:not(:disabled) {
            background: #27ae60;
            border-color: #27ae60;
        }

        .btn-locked {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: #fff;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .lock-status {
            text-align: center;
            font-size: 0.8rem;
            color: var(--accent-green);
            letter-spacing: 1px;
            margin-top: 4px;
            min-height: 1.2em;
        }

        .lock-status.is-locked {
            color: var(--accent-red);
            font-weight: 700;
        }

        /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tabs-container {
            max-width: 920px;
            width: 100%;
            margin: 14px auto 0;
            padding: 0 10px;
        }

        .tabs-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 4px;
        }

        .tab-button {
            padding: 8px 20px;
            background: transparent;
            border: none;
            border-radius: 6px 6px 0 0;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: var(--gold);
            background: rgba(201, 168, 76, 0.1);
        }

        .tab-button.active {
            color: var(--gold);
            background: rgba(201, 168, 76, 0.15);
            border-bottom: 2px solid var(--gold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            padding: 20px;
        }

        .admin-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .test-mode-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }

        .test-inputs {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .test-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .test-input-group label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .test-input-group input,
        .test-input-group select {
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.95rem;
            width: 120px;
        }

        .test-input-group input:focus,
        .test-input-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .test-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* â”€â”€ Chat Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-header {
            padding: 12px 16px;
            background: rgba(10, 14, 39, 0.5);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .chat-header h3 {
            color: var(--gold);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .chat-user-setup {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-user-setup input {
            flex: 1;
            padding: 6px 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.85rem;
        }

        .chat-user-info {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .chat-user-info strong {
            color: var(--gold);
        }

        .btn-small {
            padding: 3px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 8px;
        }

        .btn-small:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--gold);
        }

        .chat-loading {
            text-align: center;
            color: var(--text-dim);
            padding: 20px;
            font-size: 0.85rem;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding: 8px;
            background: rgba(20, 25, 55, 0.5);
            border-radius: 6px;
            border-left: 2px solid var(--gold);
        }

        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-message-user {
            font-weight: 700;
            color: var(--gold);
            font-size: 0.85rem;
        }

        .chat-message-time {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .chat-message-text {
            color: var(--text);
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .chat-reaction {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            background: rgba(201, 168, 76, 0.15);
            border: 1px solid rgba(201, 168, 76, 0.3);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text);
        }

        .chat-reaction-picker {
            display: none;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(201, 168, 76, 0.1);
        }

        .chat-message:hover .chat-reaction-picker {
            display: flex;
        }

        .reaction-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            background: rgba(201, 168, 76, 0.2);
            border-color: var(--gold);
            transform: scale(1.1);
        }

        .chat-input-container {
            padding: 12px;
            background: rgba(10, 14, 39, 0.5);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .chat-input-container input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .chat-input-container input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .chat-input-container input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-input-container button {
            padding: 8px 16px;
            background: var(--gold);
            color: var(--bg-dark);
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .chat-input-container button:hover {
            background: var(--gold-light);
        }

        .chat-input-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* â”€â”€ Live Scoreboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .live-scoreboard {
            max-width: 920px;
            width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        .live-card {
            background: var(--bg-card);
            border: 2px solid var(--accent-green);
            border-radius: 10px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            position: relative;
        }

        .live-badge {
            position: absolute;
            top: -10px;
            left: 20px;
            background: var(--accent-red);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 800;
            letter-spacing: 2px;
            padding: 3px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            animation: live-pulse 1.5s infinite;
        }

        @keyframes live-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .live-team {
            text-align: center;
            min-width: 100px;
        }

        .live-team-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-bottom: 4px;
        }

        .live-team .live-team-name {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .live-team .live-team-score {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .live-team .live-team-last-digit {
            font-size: 0.7rem;
            color: var(--gold);
            margin-top: 2px;
        }

        .live-center {
            text-align: center;
            min-width: 120px;
        }

        .live-game-time {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .live-center .live-period {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .live-center .live-clock {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            font-variant-numeric: tabular-nums;
        }

        .live-center .live-status-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .live-situation {
            font-size: 0.7rem;
            color: var(--silver);
            margin-top: 4px;
            line-height: 1.3;
        }

        .live-winner-banner {
            width: 100%;
            text-align: center;
            margin-top: 6px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .live-winner-banner .lw-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .live-winner-banner .lw-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 2px;
        }

        .live-quarter-winners {
            width: 100%;
            margin-top: 6px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .lqw-title {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 8px;
        }

        .lqw-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .lqw-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(10, 14, 39, 0.5);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 4px;
            gap: 3px;
        }

        .lqw-item.completed {
            border-color: var(--gold);
        }

        .lqw-item.active {
            border-color: var(--accent-green);
        }

        .lqw-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .lqw-score {
            font-size: 0.7rem;
            color: var(--silver);
            font-weight: 600;
        }

        .lqw-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-dim);
            text-align: center;
            line-height: 1.2;
        }

        .lqw-item.completed .lqw-name {
            color: var(--gold);
        }

        .lqw-payout {
            font-size: 0.65rem;
            color: var(--accent-green);
            font-weight: 600;
        }

        .live-error {
            text-align: center;
            color: var(--accent-red);
            font-size: 0.8rem;
            padding: 10px;
        }

        /* â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .grid-wrapper {
            margin: 14px auto;
            padding: 0 10px 0 110px;
            max-width: 920px;
            width: 100%;
            position: relative;
        }

        .team-logo-top {
            display: block;
            width: 96px;
            height: 96px;
            object-fit: contain;
            margin: 0 auto 12px;
            filter: drop-shadow(0 2px 8px rgba(201, 168, 76, 0.35));
        }

        .team-logo-left {
            position: absolute;
            left: 5px;
            top: 52%;
            transform: translateY(-50%);
            width: 65px;
            height: 65px;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(201, 168, 76, 0.35));
        }

        .team-left-label {
            position: absolute;
            left: 37px;
            top: 62%;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: center center;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--gold-light);
            white-space: nowrap;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 56px repeat(10, 1fr);
            grid-template-rows: 46px 38px repeat(10, 1fr);
            gap: 2px;
            background: var(--border);
            border: 2px solid var(--gold);
            border-radius: 8px;
            overflow: hidden;
        }

        .team-label-top {
            grid-column: 2 / -1;
            grid-row: 1;
            text-align: center;
            padding: 10px;
            background: #1a2050;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--gold-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .corner {
            grid-column: 1;
            grid-row: 1 / 3;
            background: #0d1230;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .num-header {
            background: #161d48;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--gold);
        }

        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3px;
            font-size: 0.72rem;
            font-weight: 600;
            line-height: 1.2;
            min-height: 62px;
            cursor: default;
            transition: transform 0.15s, box-shadow 0.15s;
            position: relative;
            color: #fff;
        }

        .square:hover {
            transform: scale(1.1);
            box-shadow: 0 0 18px rgba(201, 168, 76, 0.5);
            z-index: 10;
        }

        .square .name {
            word-break: break-word;
            hyphens: auto;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .square.highlight {
            outline: 3px solid var(--gold);
            outline-offset: -2px;
            box-shadow: 0 0 20px rgba(201, 168, 76, 0.7);
            z-index: 5;
        }

        .square.live-highlight {
            outline: 3px solid var(--accent-green);
            outline-offset: -2px;
            z-index: 6;
            animation: live-square-pulse 2s infinite;
        }

        @keyframes live-square-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(46,204,113,0.4); }
            50% { box-shadow: 0 0 28px rgba(46,204,113,0.8); }
        }

        /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .legend-section {
            max-width: 920px;
            width: 100%;
            padding: 0 10px;
            margin: 10px auto 30px;
        }

        .legend-title {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 12px;
            text-align: center;
        }

        .legend-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 0.82rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .legend-item:hover {
            border-color: var(--gold);
            transform: translateY(-1px);
        }

        .legend-swatch {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-name { color: var(--text); font-weight: 600; }

        .legend-item.legend-active {
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(201, 168, 76, 0.4);
            background: #1c2450;
        }

        .square.legend-highlight {
            outline: 3px solid #fff;
            outline-offset: -2px;
            z-index: 7;
            animation: legend-pulse 1.5s infinite;
        }

        @keyframes legend-pulse {
            0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.4); }
            50% { box-shadow: 0 0 22px rgba(255,255,255,0.8); }
        }

        .square.legend-dimmed {
            opacity: 0.25;
        }

        /* â”€â”€ Scoring / Payouts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .scoring-section {
            max-width: 920px;
            width: 100%;
            padding: 0 10px;
            margin: 0 auto 40px;
        }

        .scoring-title {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 12px;
            text-align: center;
        }

        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .quarter-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .quarter-card.q-active {
            border-color: var(--accent-green);
        }

        .quarter-card .q-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .quarter-card .q-scores {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .quarter-card .q-scores .team-abbr {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 42px;
        }

        .quarter-card .q-scores .team-abbr.left { text-align: right; }
        .quarter-card .q-scores .team-abbr.right { text-align: left; }

        .quarter-card .q-scores .q-score-display {
            min-width: 46px;
            padding: 6px 4px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: inherit;
            color: var(--text);
        }

        .quarter-card .q-scores .q-score-display.filled {
            color: var(--accent-green);
        }

        .quarter-card .q-scores .score-dash {
            color: var(--text-dim);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .quarter-card .q-winner {
            font-size: 0.82rem;
            color: var(--gold);
            font-weight: 600;
            min-height: 1.4em;
            margin-bottom: 2px;
        }

        .quarter-card .q-payout {
            font-size: 0.75rem;
            color: var(--accent-green);
            margin-top: 2px;
        }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
            font-size: 0.75rem;
            border-top: 1px solid var(--border);
            width: 100%;
            margin-top: auto;
        }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 700px) {
            .grid-container {
                grid-template-columns: 42px repeat(10, 1fr);
                gap: 1px;
            }
            .grid-wrapper { padding-left: 40px; }
            .team-left-label { left: -2px; font-size: 0.8rem; }
            .square { font-size: 0.52rem; min-height: 46px; padding: 2px; }
            .num-header { font-size: 0.85rem; }
            .team-label-top { font-size: 0.8rem; padding: 6px; }
            .header h1 { font-size: 1.5rem; }
            .scoring-grid { grid-template-columns: repeat(2, 1fr); }
            .live-team .live-team-score { font-size: 2rem; }
            .lqw-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media print {
            body { background: white; color: #222; }
            .header { background: none; }
            .header h1 { background: none; -webkit-text-fill-color: #333; color: #333; }
            .tabs-container { display: none; }
            .controls { display: none; }
            .lock-status { display: none; }
            .live-scoreboard { display: none !important; }
            .square {
                border: 1px solid #ccc; color: #222;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            .grid-container { border-color: #333; }
        }
    </style>
</head>
<body>

<div class="header">
    <img src="moe-logo.png" alt="Men of Emanuel" class="header-logo" />
    <h1>MOE Super Bowl Squares</h1>
    <div class="subtitle">Super Bowl LX</div>
    <div class="game-info">
        <span id="team-afc-full">New England Patriots</span>
        <span class="vs">vs</span>
        <span id="team-nfc-full">Seattle Seahawks</span>
    </div>
    <div class="game-date">Sunday, February 8, 2026 &bull; Levi's Stadium, Santa Clara, CA</div>

    <div class="pot-info">
        <div class="pot-item">
            <div class="label">Total Collected</div>
            <div class="value" id="total-pot">$900</div>
        </div>
        <div class="pot-item">
            <div class="label">Prize Pool (50%)</div>
            <div class="value" id="prize-pool">$450</div>
        </div>
        <div class="pot-item">
            <div class="label">Men of Emanuel (50%)</div>
            <div class="value" id="moe-share">$450</div>
        </div>
        <div class="pot-item">
            <div class="label">Per Square</div>
            <div class="value">$9</div>
        </div>
        <div class="pot-item">
            <div class="label">Squares Sold</div>
            <div class="value">100</div>
        </div>
    </div>
</div>

<div class="main-layout">
    <div class="content-area">
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('live')">Live Score</button>
                <button class="tab-button tab-button-chat" onclick="switchTab('chat')">Chat</button>
                <button class="tab-button" onclick="switchTab('admin')">Admin</button>
            </div>

    <div id="tab-live" class="tab-content active">
        <div class="live-scoreboard" id="live-scoreboard">
            <div class="live-card" id="live-card">
                <div class="live-badge">LIVE</div>
                <div class="live-team" id="live-team-top">
                    <img class="live-team-logo" src="https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" alt="NE" />
                    <div class="live-team-name" id="live-name-top">NE</div>
                    <div class="live-team-score" id="live-score-top">--</div>
                    <div class="live-team-last-digit">last digit: <strong id="live-digit-top">-</strong></div>
                </div>
                <div class="live-center">
                    <div class="live-game-time" id="live-game-time"></div>
                    <div class="live-period" id="live-period">--</div>
                    <div class="live-clock" id="live-clock">--:--</div>
                    <div class="live-status-text" id="live-status-text">Connecting...</div>
                    <div class="live-situation" id="live-situation"></div>
                </div>
                <div class="live-team" id="live-team-left">
                    <img class="live-team-logo" src="https://a.espncdn.com/i/teamlogos/nfl/500/sea.png" alt="SEA" />
                    <div class="live-team-name" id="live-name-left">SEA</div>
                    <div class="live-team-score" id="live-score-left">--</div>
                    <div class="live-team-last-digit">last digit: <strong id="live-digit-left">-</strong></div>
                </div>
                <div class="live-winner-banner">
                    <div class="lw-label">Currently Winning Square</div>
                    <div class="lw-name" id="live-current-winner">--</div>
                </div>
                <div class="live-quarter-winners" id="live-quarter-winners">
                    <div class="lqw-title">Quarter Winners</div>
                    <div class="lqw-grid">
                        <div class="lqw-item" id="lqw-Q1">
                            <span class="lqw-label">Q1</span>
                            <span class="lqw-score" id="lqw-score-Q1"></span>
                            <span class="lqw-name" id="lqw-name-Q1">--</span>
                            <span class="lqw-payout" id="lqw-payout-Q1"></span>
                        </div>
                        <div class="lqw-item" id="lqw-Q2">
                            <span class="lqw-label">Q2</span>
                            <span class="lqw-score" id="lqw-score-Q2"></span>
                            <span class="lqw-name" id="lqw-name-Q2">--</span>
                            <span class="lqw-payout" id="lqw-payout-Q2"></span>
                        </div>
                        <div class="lqw-item" id="lqw-Q3">
                            <span class="lqw-label">Q3</span>
                            <span class="lqw-score" id="lqw-score-Q3"></span>
                            <span class="lqw-name" id="lqw-name-Q3">--</span>
                            <span class="lqw-payout" id="lqw-payout-Q3"></span>
                        </div>
                        <div class="lqw-item" id="lqw-Final">
                            <span class="lqw-label">Final</span>
                            <span class="lqw-score" id="lqw-score-Final"></span>
                            <span class="lqw-name" id="lqw-name-Final">--</span>
                            <span class="lqw-payout" id="lqw-payout-Final"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-chat" class="tab-content">
        <div style="max-width: 800px; width: 100%; margin: 0 auto; height: 600px;">
            <div class="chat-container">
                <div class="chat-header">
                    <h3>Game Chat</h3>
                    <div class="chat-user-setup" id="chat-user-setup-mobile">
                        <input type="text" id="chat-username-mobile" placeholder="Enter your name" maxlength="20" />
                        <button onclick="setUsernameMobile()">Join</button>
                    </div>
                    <div class="chat-user-info" id="chat-user-info-mobile" style="display: none;">
                        <span><strong id="display-username-mobile"></strong></span>
                        <button class="btn-small" onclick="changeUsernameMobile()">Change</button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages-mobile">
                    <div class="chat-loading">Loading messages...</div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" id="chat-input-mobile" placeholder="Type a message..." maxlength="200" disabled />
                    <button id="chat-send-btn-mobile" onclick="sendMessageMobile()" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-admin" class="tab-content">
        <div class="admin-controls">
            <div class="admin-buttons">
                <button class="btn btn-shuffle" id="btn-shuffle" onclick="doShuffle()">Shuffle</button>
                <button class="btn btn-lock" id="btn-lock" onclick="doLock()">Lock In</button>
            </div>
            <div class="lock-status" id="lock-status"></div>
            
            <div class="test-mode-section">
                <h3 style="color: var(--gold); margin-bottom: 10px; font-size: 1rem;">Test Live Score</h3>
                <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 10px;">Simulate different scores to test the live scoreboard</p>
                <div class="test-inputs">
                    <div class="test-input-group">
                        <label>NE Score:</label>
                        <input type="number" id="test-score-top" min="0" max="99" placeholder="0" />
                    </div>
                    <div class="test-input-group">
                        <label>SEA Score:</label>
                        <input type="number" id="test-score-left" min="0" max="99" placeholder="0" />
                    </div>
                    <div class="test-input-group">
                        <label>Quarter:</label>
                        <select id="test-quarter">
                            <option value="0">Pre-game</option>
                            <option value="1">Q1</option>
                            <option value="2">Q2</option>
                            <option value="3">Halftime</option>
                            <option value="4">Q3</option>
                            <option value="5">Q4</option>
                            <option value="6">Final</option>
                        </select>
                    </div>
                </div>
                <div class="test-buttons">
                    <button class="btn btn-shuffle" onclick="applyTestScore()">Apply Test Score</button>
                    <button class="btn btn-lock" onclick="clearTestMode()">Clear & Use Live API</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid-wrapper">
    <img class="team-logo-top" src="https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" alt="Patriots" />
    <img class="team-logo-left" src="https://a.espncdn.com/i/teamlogos/nfl/500/sea.png" alt="Seahawks" />
    <div class="team-left-label" id="team-left-label"></div>
    <div class="grid-container" id="grid"></div>
</div>

<div class="legend-section">
    <div class="legend-title">Participants</div>
    <div class="legend-grid" id="legend"></div>
</div>

<div class="scoring-section">
    <div class="scoring-title">Quarter Results</div>
    <div class="scoring-grid" id="scoring"></div>
</div>

    </div><!-- End content-area -->

    <div class="chat-sidebar">
        <div class="chat-container">
            <div class="chat-header">
                <h3>Game Chat</h3>
                <div class="chat-user-setup" id="chat-user-setup">
                    <input type="text" id="chat-username" placeholder="Enter your name" maxlength="20" />
                    <button onclick="setUsername()">Join</button>
                </div>
                <div class="chat-user-info" id="chat-user-info" style="display: none;">
                    <span><strong id="display-username"></strong></span>
                    <button class="btn-small" onclick="changeUsername()">Change</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="chat-loading">Loading messages...</div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type a message..." maxlength="200" disabled />
                <button id="chat-send-btn" onclick="sendMessage()" disabled>Send</button>
            </div>
        </div>
    </div>
</div><!-- End main-layout -->

<div class="footer">
    MOE Super Bowl Squares &bull; Super Bowl LX &bull; 2026
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// ================================================================
// FIREBASE INITIALIZATION
// ================================================================
let db = null;
let chatRef = null;
let analyticsRef = null;

try {
    if (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey !== 'YOUR_API_KEY') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        chatRef = db.ref('messages');
        analyticsRef = db.ref('analytics');
        console.log('Firebase initialized successfully');
    } else {
        console.warn('Firebase not configured. Chat will not work until you add your Firebase credentials to firebase-config.js');
    }
} catch (error) {
    console.error('Firebase initialization error:', error);
}

// ================================================================
// ANALYTICS & ACCESS LOGGING
// ================================================================
function logPageView() {
    if (!analyticsRef) return;
    
    const sessionId = sessionStorage.getItem('sessionId') || 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    sessionStorage.setItem('sessionId', sessionId);
    
    const chatUsername = localStorage.getItem('chatUsername') || 'anonymous';
    
    const logData = {
        timestamp: Date.now(),
        sessionId: sessionId,
        chatUsername: chatUsername,
        userAgent: navigator.userAgent,
        screen: `${window.screen.width}x${window.screen.height}`,
        viewport: `${window.innerWidth}x${window.innerHeight}`,
        referrer: document.referrer || 'direct',
        page: 'main',
        url: window.location.href
    };
    
    analyticsRef.child('pageviews').push(logData);
}

function logEvent(eventType, eventData = {}) {
    if (!analyticsRef) return;
    
    const sessionId = sessionStorage.getItem('sessionId') || 'unknown';
    const chatUsername = localStorage.getItem('chatUsername') || 'anonymous';
    
    const logData = {
        timestamp: Date.now(),
        sessionId: sessionId,
        chatUsername: chatUsername,
        eventType: eventType,
        ...eventData
    };
    
    analyticsRef.child('events').push(logData);
}

// Log initial page view
if (analyticsRef) {
    logPageView();
}

// ================================================================
// CHAT FUNCTIONALITY
// ================================================================
let currentUsername = localStorage.getItem('chatUsername') || '';
let messagesListener = null;

// Desktop sidebar chat functions
function setUsername() {
    const input = document.getElementById('chat-username');
    const username = input.value.trim();
    
    if (!username) {
        alert('Please enter a name');
        return;
    }
    
    if (username.length < 2) {
        alert('Name must be at least 2 characters');
        return;
    }
    
    currentUsername = username;
    localStorage.setItem('chatUsername', username);
    
    document.getElementById('chat-user-setup').style.display = 'none';
    document.getElementById('chat-user-info').style.display = 'block';
    document.getElementById('display-username').textContent = username;
    document.getElementById('chat-input').disabled = false;
    document.getElementById('chat-send-btn').disabled = false;
    
    // Log username set event
    logEvent('username_set', { username: username });
    
    // Also update mobile if present
    const mobileSetup = document.getElementById('chat-user-setup-mobile');
    const mobileInfo = document.getElementById('chat-user-info-mobile');
    if (mobileSetup && mobileInfo) {
        mobileSetup.style.display = 'none';
        mobileInfo.style.display = 'block';
        document.getElementById('display-username-mobile').textContent = username;
        document.getElementById('chat-input-mobile').disabled = false;
        document.getElementById('chat-send-btn-mobile').disabled = false;
    }
    
    // Start listening to messages
    if (chatRef) {
        listenToMessages();
    }
}

function changeUsername() {
    document.getElementById('chat-user-setup').style.display = 'flex';
    document.getElementById('chat-user-info').style.display = 'none';
    document.getElementById('chat-input').disabled = true;
    document.getElementById('chat-send-btn').disabled = true;
    document.getElementById('chat-username').value = currentUsername;
    
    // Also update mobile if present
    const mobileSetup = document.getElementById('chat-user-setup-mobile');
    const mobileInfo = document.getElementById('chat-user-info-mobile');
    if (mobileSetup && mobileInfo) {
        mobileSetup.style.display = 'flex';
        mobileInfo.style.display = 'none';
        document.getElementById('chat-input-mobile').disabled = true;
        document.getElementById('chat-send-btn-mobile').disabled = true;
        document.getElementById('chat-username-mobile').value = currentUsername;
    }
    
    // Stop listening
    if (messagesListener) {
        chatRef.off('child_added', messagesListener);
        messagesListener = null;
    }
}

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    if (!chatRef) {
        alert('Chat is not configured. Please add Firebase credentials.');
        return;
    }
    
    const messageData = {
        username: currentUsername,
        text: message,
        timestamp: Date.now()
    };
    
    chatRef.push(messageData);
    input.value = '';
    
    logEvent('chat_message', { username: currentUsername, messageLength: message.length });
}

function listenToMessages() {
    if (!chatRef) {
        const setupMessage = `
            <div style="text-align: center; padding: 30px; color: var(--text-dim);">
                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ”¥</div>
                <div style="font-weight: 600; margin-bottom: 10px; color: var(--gold);">Firebase Setup Required</div>
                <div style="font-size: 0.85rem; line-height: 1.5;">
                    Chat needs Firebase to work.<br>
                    See <strong>FIREBASE_SETUP.md</strong> for instructions.<br><br>
                    Open <strong>firebase-setup-helper.html</strong> for guided setup.
                </div>
            </div>
        `;
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) messagesContainer.innerHTML = setupMessage;
        
        const messagesContainerMobile = document.getElementById('chat-messages-mobile');
        if (messagesContainerMobile) messagesContainerMobile.innerHTML = setupMessage;
        return;
    }
    
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) messagesContainer.innerHTML = '';
    
    const messagesContainerMobile = document.getElementById('chat-messages-mobile');
    if (messagesContainerMobile) messagesContainerMobile.innerHTML = '';
    
    // Listen for new messages (limit to last 50)
    chatRef.orderByChild('timestamp').limitToLast(50).on('child_added', function(snapshot) {
        const msg = snapshot.val();
        const msgId = snapshot.key;
        addMessageToUI(msg, msgId);
        
        // Listen for reaction changes on this message
        chatRef.child(msgId).child('reactions').on('value', function(reactionSnapshot) {
            updateReactions(msgId, reactionSnapshot.val());
        });
    });
}

function addMessageToUI(msg, msgId) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message';
    messageDiv.dataset.messageId = msgId;
    
    const time = new Date(msg.timestamp);
    const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    
    const reactions = msg.reactions || {};
    const reactionCounts = {};
    Object.values(reactions).forEach(emoji => {
        reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
    });
    
    let reactionsHTML = '';
    if (Object.keys(reactionCounts).length > 0) {
        reactionsHTML = '<div class="chat-reactions">';
        for (const [emoji, count] of Object.entries(reactionCounts)) {
            reactionsHTML += `<span class="chat-reaction">${emoji} ${count}</span>`;
        }
        reactionsHTML += '</div>';
    }
    
    messageDiv.innerHTML = `
        <div class="chat-message-header">
            <span class="chat-message-user">${escapeHtml(msg.username)}</span>
            <span class="chat-message-time">${timeStr}</span>
        </div>
        <div class="chat-message-text">${escapeHtml(msg.text)}</div>
        ${reactionsHTML}
        <div class="chat-reaction-picker">
            <button class="reaction-btn" onclick="addReaction('${msgId}', 'ðŸ‘')" title="Thumbs up">ðŸ‘</button>
            <button class="reaction-btn" onclick="addReaction('${msgId}', 'â¤ï¸')" title="Heart">â¤ï¸</button>
            <button class="reaction-btn" onclick="addReaction('${msgId}', 'ðŸ˜‚')" title="Laughing">ðŸ˜‚</button>
            <button class="reaction-btn" onclick="addReaction('${msgId}', 'ðŸŽ‰')" title="Party">ðŸŽ‰</button>
            <button class="reaction-btn" onclick="addReaction('${msgId}', 'ðŸ”¥')" title="Fire">ðŸ”¥</button>
            <button class="reaction-btn" onclick="addReaction('${msgId}', 'ðŸˆ')" title="Football">ðŸˆ</button>
        </div>
    `;
    
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    const messagesContainerMobile = document.getElementById('chat-messages-mobile');
    if (messagesContainerMobile) {
        const mobileMsgDiv = messageDiv.cloneNode(true);
        messagesContainerMobile.appendChild(mobileMsgDiv);
        messagesContainerMobile.scrollTop = messagesContainerMobile.scrollHeight;
    }
}

function updateReactions(msgId, reactions) {
    const reactionCounts = {};
    if (reactions) {
        Object.values(reactions).forEach(emoji => {
            reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
        });
    }
    
    let reactionsHTML = '';
    if (Object.keys(reactionCounts).length > 0) {
        reactionsHTML = '<div class="chat-reactions">';
        for (const [emoji, count] of Object.entries(reactionCounts)) {
            reactionsHTML += `<span class="chat-reaction">${emoji} ${count}</span>`;
        }
        reactionsHTML += '</div>';
    }
    
    // Update desktop
    const desktopMsg = document.querySelector(`#chat-messages .chat-message[data-message-id="${msgId}"]`);
    if (desktopMsg) {
        let existingReactions = desktopMsg.querySelector('.chat-reactions');
        if (existingReactions) {
            existingReactions.remove();
        }
        if (reactionsHTML) {
            const textDiv = desktopMsg.querySelector('.chat-message-text');
            textDiv.insertAdjacentHTML('afterend', reactionsHTML);
        }
    }
    
    // Update mobile
    const mobileMsg = document.querySelector(`#chat-messages-mobile .chat-message[data-message-id="${msgId}"]`);
    if (mobileMsg) {
        let existingReactions = mobileMsg.querySelector('.chat-reactions');
        if (existingReactions) {
            existingReactions.remove();
        }
        if (reactionsHTML) {
            const textDiv = mobileMsg.querySelector('.chat-message-text');
            textDiv.insertAdjacentHTML('afterend', reactionsHTML);
        }
    }
}

function addReaction(msgId, emoji) {
    if (!chatRef || !currentUsername) return;
    
    // Add reaction with username as key to prevent duplicates per user
    const userKey = currentUsername.replace(/[.#$[\]]/g, '_'); // Sanitize for Firebase key
    chatRef.child(msgId).child('reactions').child(userKey).set(emoji);
}

// Mobile chat functions (mirrors of desktop)
function setUsernameMobile() {
    const input = document.getElementById('chat-username-mobile');
    const username = input.value.trim();
    
    if (!username) {
        alert('Please enter a name');
        return;
    }
    
    if (username.length < 2) {
        alert('Name must be at least 2 characters');
        return;
    }
    
    currentUsername = username;
    localStorage.setItem('chatUsername', username);
    
    document.getElementById('chat-user-setup-mobile').style.display = 'none';
    document.getElementById('chat-user-info-mobile').style.display = 'block';
    document.getElementById('display-username-mobile').textContent = username;
    document.getElementById('chat-input-mobile').disabled = false;
    document.getElementById('chat-send-btn-mobile').disabled = false;
    
    // Also update desktop if present
    const desktopSetup = document.getElementById('chat-user-setup');
    const desktopInfo = document.getElementById('chat-user-info');
    if (desktopSetup && desktopInfo) {
        desktopSetup.style.display = 'none';
        desktopInfo.style.display = 'block';
        document.getElementById('display-username').textContent = username;
        document.getElementById('chat-input').disabled = false;
        document.getElementById('chat-send-btn').disabled = false;
    }
    
    // Start listening to messages
    if (chatRef) {
        listenToMessages();
    }
}

function changeUsernameMobile() {
    document.getElementById('chat-user-setup-mobile').style.display = 'flex';
    document.getElementById('chat-user-info-mobile').style.display = 'none';
    document.getElementById('chat-input-mobile').disabled = true;
    document.getElementById('chat-send-btn-mobile').disabled = true;
    document.getElementById('chat-username-mobile').value = currentUsername;
    
    // Also update desktop if present
    const desktopSetup = document.getElementById('chat-user-setup');
    const desktopInfo = document.getElementById('chat-user-info');
    if (desktopSetup && desktopInfo) {
        desktopSetup.style.display = 'flex';
        desktopInfo.style.display = 'none';
        document.getElementById('chat-input').disabled = true;
        document.getElementById('chat-send-btn').disabled = true;
        document.getElementById('chat-username').value = currentUsername;
    }
    
    // Stop listening
    if (messagesListener) {
        chatRef.off('child_added', messagesListener);
        messagesListener = null;
    }
}

function sendMessageMobile() {
    const input = document.getElementById('chat-input-mobile');
    const message = input.value.trim();
    
    if (!message) return;
    if (!chatRef) {
        alert('Chat is not configured. Please add Firebase credentials.');
        return;
    }
    
    const messageData = {
        username: currentUsername,
        text: message,
        timestamp: Date.now()
    };
    
    chatRef.push(messageData);
    input.value = '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize chat if username is already set
if (currentUsername && chatRef) {
    // Desktop
    const desktopSetup = document.getElementById('chat-user-setup');
    const desktopInfo = document.getElementById('chat-user-info');
    if (desktopSetup && desktopInfo) {
        desktopSetup.style.display = 'none';
        desktopInfo.style.display = 'block';
        document.getElementById('display-username').textContent = currentUsername;
        document.getElementById('chat-input').disabled = false;
        document.getElementById('chat-send-btn').disabled = false;
    }
    
    // Mobile
    const mobileSetup = document.getElementById('chat-user-setup-mobile');
    const mobileInfo = document.getElementById('chat-user-info-mobile');
    if (mobileSetup && mobileInfo) {
        mobileSetup.style.display = 'none';
        mobileInfo.style.display = 'block';
        document.getElementById('display-username-mobile').textContent = currentUsername;
        document.getElementById('chat-input-mobile').disabled = false;
        document.getElementById('chat-send-btn-mobile').disabled = false;
    }
}

// Allow Enter key to send messages
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }
    
    const chatInputMobile = document.getElementById('chat-input-mobile');
    if (chatInputMobile) {
        chatInputMobile.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessageMobile();
            }
        });
    }
});

// ================================================================
// CONFIGURATION
// ================================================================
const CONFIG = {
    teamTop:  "Patriots",
    teamLeft: "Seahawks",
    teamTopAbbr:  "NE",
    teamLeftAbbr: "SEA",
    pricePerSquare: 9,
    seed: 2026,
    payouts: { Q1: 0.20, Q2: 0.20, Q3: 0.20, Final: 0.40 },
    // ESPN API â€” NFL scoreboard (public, CORS-friendly)
    espnUrl: "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard",
    pollInterval: 30000   // 30 seconds
};

// ================================================================
// RAW PARTICIPANT DATA  [Name, $ Amount, # Squares]
// ================================================================
const rawEntries = [
    ["David Shapiro",     0, 0],
    ["Barry Shapiro",    36, 4],
    ["Bill LeGrand",     36, 4],
    ["Stephen Ochs",     18, 2],
    ["Robert Goldsobel", 36, 4],
    ["Erick Searfoss",   36, 4],
    ["Jeffrey Lane",     18, 2],
    ["Ben Smith",        36, 4],
    ["Mel Kessler",      18, 2],
    ["David Shapiro",    54, 6],
    ["Mark Wolf",        36, 4],
    ["Peter Brown",      18, 2],
    ["David Hannes",     18, 2],
    ["Sid Plait",        36, 4],
    ["Scott Mason",      18, 2],
    ["Michael Obstein",  72, 8],
    ["Arnold Bedak",     36, 4],
    ["T. Weiss",         54, 6],
    ["Adam Wilkens",     72, 8],
    ["Brandon Bagley",  108, 12],
    ["Stephen Ochs",     18, 2],
    ["Jonathan Andes",   36, 4],
    ["Sid Plait",        36, 4],
    ["Robert Goldsobel", 36, 4],
    ["David Shapiro",    18, 2],
];

// ================================================================
// CONSOLIDATE
// ================================================================
const pMap = {};
rawEntries.forEach(([name, amount, squares]) => {
    if (!pMap[name]) pMap[name] = { name, totalAmount: 0, totalSquares: 0 };
    pMap[name].totalAmount  += amount;
    pMap[name].totalSquares += squares;
});
const participants   = Object.values(pMap).sort((a, b) => b.totalSquares - a.totalSquares);
const totalSqSold    = participants.reduce((s, p) => s + p.totalSquares, 0);
const cellsPerSquare = 100 / totalSqSold;

const COLORS = [
    "#2563eb","#dc2626","#16a34a","#d97706","#7c3aed",
    "#db2777","#0891b2","#ea580c","#4f46e5","#059669",
    "#9333ea","#e11d48","#0d9488","#ca8a04","#6366f1",
    "#be185d","#1d4ed8","#b91c1c"
];
participants.forEach((p, i) => { p.color = COLORS[i % COLORS.length]; });

// ================================================================
// RNG
// ================================================================
let currentSeed = CONFIG.seed;

function mulberry32(seed) {
    return () => {
        seed |= 0; seed = seed + 0x6D2B79F5 | 0;
        let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
}

function shuffleWith(arr, rng) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

// ================================================================
// STATE
// ================================================================
let isLocked   = false;
let isLiveMode = false;
let liveTimer  = null;
let cells      = [];
let colNums    = [];
let rowNums    = [];

const STORAGE_KEY = "moe_sb_squares";

function saveState() {
    const state = {
        locked: isLocked,
        seed: currentSeed
        // Scores are no longer saved - they come from API only
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
}

// ================================================================
// GENERATE LAYOUT from a given seed
// ================================================================
function generateLayout(seed) {
    const rng = mulberry32(seed);
    let c = [];
    participants.forEach(p => {
        for (let i = 0; i < p.totalSquares * cellsPerSquare; i++) c.push(p);
    });
    cells   = shuffleWith(c, rng);
    colNums = shuffleWith([0,1,2,3,4,5,6,7,8,9], rng);
    rowNums = shuffleWith([0,1,2,3,4,5,6,7,8,9], rng);
}

// ================================================================
// LOOKUP â€” given two scores, find the winning participant
// ================================================================
function lookupWinner(topScore, leftScore) {
    const topDigit  = topScore % 10;
    const leftDigit = leftScore % 10;
    const colIdx = colNums.indexOf(topDigit);
    const rowIdx = rowNums.indexOf(leftDigit);
    if (colIdx === -1 || rowIdx === -1) return null;
    return { participant: cells[rowIdx * 10 + colIdx], row: rowIdx, col: colIdx };
}

// ================================================================
// RENDER GRID
// ================================================================
function shortName(name) {
    const parts = name.split(" ");
    if (parts.length >= 2 && parts[0] !== "The")
        return parts[0][0] + ". " + parts.slice(1).join(" ");
    return name;
}

function renderGrid() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    const corner = document.createElement("div");
    corner.className = "corner";
    corner.textContent = "\uD83C\uDFC8";
    corner.style.gridRow = "1 / 3";
    corner.style.gridColumn = "1";
    grid.appendChild(corner);

    const topLabel = document.createElement("div");
    topLabel.className = "team-label-top";
    topLabel.textContent = CONFIG.teamTop;
    grid.appendChild(topLabel);

    colNums.forEach((n, i) => {
        const el = document.createElement("div");
        el.className = "num-header";
        el.style.gridRow = "2";
        el.style.gridColumn = String(i + 2);
        el.textContent = n;
        grid.appendChild(el);
    });

    rowNums.forEach((n, i) => {
        const el = document.createElement("div");
        el.className = "num-header";
        el.style.gridRow = String(i + 3);
        el.style.gridColumn = "1";
        el.textContent = n;
        grid.appendChild(el);
    });

    for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
            const p  = cells[r * 10 + c];
            const el = document.createElement("div");
            el.className = "square";
            el.dataset.row = r;
            el.dataset.col = c;
            el.style.gridRow    = String(r + 3);
            el.style.gridColumn = String(c + 2);
            el.style.background = "linear-gradient(145deg, " + p.color + "ee, " + p.color + "bb)";

            const span = document.createElement("span");
            span.className = "name";
            span.textContent = shortName(p.name);
            el.appendChild(span);

            el.title = p.name + "\n" + p.totalSquares + " squares ($" + p.totalAmount + ")\nCol " + colNums[c] + "  /  Row " + rowNums[r];
            
            // Add click handler to use same highlight as legend
            el.addEventListener("click", function() {
                toggleLegendHighlight(p.name);
                logEvent('square_click', { participant: p.name });
            });
            el.style.cursor = "pointer";
            
            grid.appendChild(el);
        }
    }

    document.getElementById("team-left-label").textContent = CONFIG.teamLeft;
}

// ================================================================
// RENDER LEGEND
// ================================================================
var activeLegendName = null;

function getLastName(name) {
    var parts = name.trim().split(" ");
    if (parts[0] === "The") return parts.slice(1).join(" ");
    return parts[parts.length - 1];
}

function renderLegend() {
    const legend = document.getElementById("legend");
    legend.innerHTML = "";

    // Sort participants alphabetically by last name
    var sorted = [...participants].sort((a, b) => {
        var lastA = getLastName(a.name).toLowerCase();
        var lastB = getLastName(b.name).toLowerCase();
        if (lastA < lastB) return -1;
        if (lastA > lastB) return 1;
        return a.name.localeCompare(b.name);
    });

    sorted.forEach(p => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML =
            '<div class="legend-swatch" style="background:' + p.color + '"></div>' +
            '<span class="legend-name">' + shortName(p.name) + '</span>';
        item.dataset.participant = p.name;
        item.addEventListener("click", function() {
            toggleLegendHighlight(p.name);
        });
        legend.appendChild(item);
    });
}

function toggleLegendHighlight(name) {
    // Clear previous legend highlights
    document.querySelectorAll(".square.legend-highlight, .square.legend-dimmed").forEach(function(el) {
        el.classList.remove("legend-highlight");
        el.classList.remove("legend-dimmed");
    });
    document.querySelectorAll(".legend-item.legend-active").forEach(function(el) {
        el.classList.remove("legend-active");
    });

    // If clicking the same name again, just deactivate
    if (activeLegendName === name) {
        activeLegendName = null;
        return;
    }

    activeLegendName = name;

    // Highlight the legend item
    document.querySelectorAll(".legend-item").forEach(function(el) {
        if (el.dataset.participant === name) {
            el.classList.add("legend-active");
        }
    });

    // Highlight matching squares, dim the rest
    document.querySelectorAll(".square").forEach(function(sq) {
        var row = parseInt(sq.dataset.row, 10);
        var col = parseInt(sq.dataset.col, 10);
        var p = cells[row * 10 + col];
        if (p && p.name === name) {
            sq.classList.add("legend-highlight");
        } else {
            sq.classList.add("legend-dimmed");
        }
    });
}

// ================================================================
// RENDER SCORING CARDS
// ================================================================
const totalPot  = totalSqSold * CONFIG.pricePerSquare;
const prizePool = totalPot * 0.5;
const moeShare  = totalPot * 0.5;

function renderScoring() {
    document.getElementById("total-pot").textContent   = "$" + totalPot.toLocaleString();
    document.getElementById("prize-pool").textContent  = "$" + prizePool.toLocaleString();
    document.getElementById("moe-share").textContent   = "$" + moeShare.toLocaleString();

    const scoring = document.getElementById("scoring");
    scoring.innerHTML = "";

    ["Q1","Q2","Q3","Final"].forEach(function(q) {
        const payout = Math.round(prizePool * CONFIG.payouts[q]);
        const card = document.createElement("div");
        card.className = "quarter-card";
        card.id = "card-" + q;
        card.innerHTML =
            '<div class="q-label">' + (q === "Final" ? "Final Score" : q) + '</div>' +
            '<div class="q-scores">' +
                '<span class="team-abbr left">' + CONFIG.teamTopAbbr + '</span>' +
                '<span class="q-score-display" id="score-display-top-' + q + '">&mdash;</span>' +
                '<span class="score-dash">&ndash;</span>' +
                '<span class="q-score-display" id="score-display-left-' + q + '">&mdash;</span>' +
                '<span class="team-abbr right">' + CONFIG.teamLeftAbbr + '</span>' +
            '</div>' +
            '<div class="q-winner" id="winner-' + q + '">&mdash;</div>' +
            '<div class="q-payout">$' + payout.toLocaleString() + '</div>';
        scoring.appendChild(card);
    });
}

// ================================================================
// SCORE â†’ WINNER LOOKUP (manual entry)
// ================================================================
// These functions are no longer needed as scores are populated from API only
// Keeping stubs for backwards compatibility
function onScoreChange(quarter) {
    // No-op: scores are now read-only from API
}

function recheckAllScores() {
    // No-op: scores are now read-only from API
}

function clearHighlights() {
    document.querySelectorAll(".square.highlight, .square.live-highlight").forEach(function(el) {
        el.classList.remove("highlight");
        el.classList.remove("live-highlight");
    });
}

function clearLegendHighlights() {
    activeLegendName = null;
    document.querySelectorAll(".square.legend-highlight, .square.legend-dimmed").forEach(function(el) {
        el.classList.remove("legend-highlight");
        el.classList.remove("legend-dimmed");
    });
    document.querySelectorAll(".legend-item.legend-active").forEach(function(el) {
        el.classList.remove("legend-active");
    });
}

// Re-highlight all quarters that have scores
function reapplyAllHighlights() {
    clearHighlights();
    ["Q1","Q2","Q3","Final"].forEach(function(q) {
        var topInput  = document.getElementById("score-top-" + q);
        var leftInput = document.getElementById("score-left-" + q);
        if (topInput && leftInput && topInput.value !== "" && leftInput.value !== "") {
            var result = lookupWinner(parseInt(topInput.value, 10), parseInt(leftInput.value, 10));
            if (result) {
                var sq = document.querySelector('.square[data-row="' + result.row + '"][data-col="' + result.col + '"]');
                if (sq) sq.classList.add("highlight");
            }
        }
    });
    // If live mode, also add the live highlight
    if (isLiveMode && lastLiveTopScore !== null && lastLiveLeftScore !== null) {
        var liveResult = lookupWinner(lastLiveTopScore, lastLiveLeftScore);
        if (liveResult) {
            var sq = document.querySelector('.square[data-row="' + liveResult.row + '"][data-col="' + liveResult.col + '"]');
            if (sq) sq.classList.add("live-highlight");
        }
    }
}

function recheckAllScores() {
    ["Q1","Q2","Q3","Final"].forEach(function(q) { onScoreChange(q); });
}

// ================================================================
// SHUFFLE & LOCK
// ================================================================
function doShuffle() {
    if (isLocked) return;
    
    var times = prompt('How many times do you want to shuffle the grid?', '1');
    if (times === null) return; // User canceled
    
    var shuffleCount = parseInt(times, 10);
    if (isNaN(shuffleCount) || shuffleCount < 1) {
        alert('Please enter a valid number (1 or greater)');
        return;
    }
    
    // Perform multiple shuffles
    for (var i = 0; i < shuffleCount; i++) {
        currentSeed = Date.now() + i; // Ensure different seed each time
        generateLayout(currentSeed);
    }
    
    renderGrid();
    clearHighlights();
    clearLegendHighlights();
    recheckAllScores();
    saveState();
    
    alert('Grid shuffled ' + shuffleCount + ' time' + (shuffleCount > 1 ? 's' : '') + '!');
}

function doLock() {
    if (isLocked) {
        isLocked = false;
        updateLockUI();
        saveState();
    } else {
        if (confirm("Lock in the current grid? You can unlock later if needed.")) {
            isLocked = true;
            updateLockUI();
            saveState();
        }
    }
}

function updateLockUI() {
    var btnShuffle = document.getElementById("btn-shuffle");
    var btnLock    = document.getElementById("btn-lock");
    var statusEl   = document.getElementById("lock-status");

    if (isLocked) {
        btnShuffle.disabled = true;
        btnLock.textContent = "Unlock";
        btnLock.className   = "btn btn-locked";
        statusEl.textContent = "GRID IS LOCKED IN";
        statusEl.className   = "lock-status is-locked";
    } else {
        btnShuffle.disabled = false;
        btnLock.textContent = "Lock In";
        btnLock.className   = "btn btn-lock";
        statusEl.textContent = "";
        statusEl.className   = "lock-status";
    }
}

// ================================================================
// TAB SWITCHING
// ================================================================
var isAdminAuthenticated = false;

function switchTab(tabName) {
    // Check if switching to admin tab
    if (tabName === 'admin' && !isAdminAuthenticated) {
        var password = prompt('Enter admin password:');
        if (password !== 'admin') {
            alert('Incorrect password');
            return;
        }
        isAdminAuthenticated = true;
    }

    // Update tab buttons
    var buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update tab content
    var contents = document.querySelectorAll('.tab-content');
    contents.forEach(function(content) {
        content.classList.remove('active');
    });
    document.getElementById('tab-' + tabName).classList.add('active');

    // Start/stop live score based on tab
    if (tabName === 'live' && !isLiveMode) {
        startLiveScore();
    }
    
    logEvent('tab_switch', { tab: tabName });
}

// ================================================================
// TEST MODE
// ================================================================
var testMode = false;
var testData = null;

function applyTestScore() {
    var topScore = parseInt(document.getElementById('test-score-top').value) || 0;
    var leftScore = parseInt(document.getElementById('test-score-left').value) || 0;
    var quarterVal = parseInt(document.getElementById('test-quarter').value) || 0;

    testMode = true;
    
    // Create mock game data
    testData = {
        competitions: [{
            competitors: [
                {
                    team: { abbreviation: 'NE' },
                    score: topScore.toString(),
                    linescores: generateMockLinescores(topScore, quarterVal)
                },
                {
                    team: { abbreviation: 'SEA' },
                    score: leftScore.toString(),
                    linescores: generateMockLinescores(leftScore, quarterVal)
                }
            ],
            status: {
                type: { name: getStatusType(quarterVal) },
                period: getPeriod(quarterVal),
                displayClock: '5:23'
            }
        }]
    };

    updateLiveDisplay(testData);
    alert('Test score applied! Switch to Live Score tab to see results.');
}

function generateMockLinescores(totalScore, quarter) {
    // Distribute score across quarters
    if (quarter === 0 || quarter === 3) return []; // Pre-game or halftime
    if (quarter === 6) quarter = 4; // Final = 4 quarters
    
    var lines = [];
    var remaining = totalScore;
    for (var i = 0; i < Math.min(quarter, 4); i++) {
        var pts = i < quarter - 1 ? Math.floor(remaining / (quarter - i)) : remaining;
        lines.push({ value: pts });
        remaining -= pts;
    }
    return lines;
}

function getStatusType(quarter) {
    if (quarter === 0) return 'STATUS_SCHEDULED';
    if (quarter === 3) return 'STATUS_HALFTIME';
    if (quarter === 6) return 'STATUS_FINAL';
    return 'STATUS_IN_PROGRESS';
}

function getPeriod(quarter) {
    if (quarter === 0) return 0;
    if (quarter === 3) return 2;
    if (quarter === 6) return 4;
    return quarter;
}

function clearTestMode() {
    testMode = false;
    testData = null;
    document.getElementById('test-score-top').value = '';
    document.getElementById('test-score-left').value = '';
    document.getElementById('test-quarter').value = '0';
    fetchLiveScore();
    alert('Test mode cleared. Now using live ESPN API data.');
}

// ================================================================
// LIVE SCORE â€” ESPN API integration
// ================================================================
var lastLiveTopScore  = null;
var lastLiveLeftScore = null;

function startLiveScore() {
    if (isLiveMode) return; // Already running
    isLiveMode = true;
    document.getElementById("live-status-text").textContent = "Connecting...";
    fetchLiveScore();
    liveTimer = setInterval(fetchLiveScore, CONFIG.pollInterval);
}

function stopLiveScore() {
    if (!isLiveMode) return;
    isLiveMode = false;
    if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
    lastLiveTopScore = null;
    lastLiveLeftScore = null;
    reapplyAllHighlights();
}

async function fetchLiveScore() {
    // If in test mode, use test data instead
    if (testMode && testData) {
        updateLiveDisplay(testData);
        return;
    }

    try {
        var response = await fetch(CONFIG.espnUrl);
        if (!response.ok) throw new Error("HTTP " + response.status);
        var data = await response.json();
        var game = findSuperBowl(data);
        if (game) {
            updateLiveDisplay(game);
        } else {
            document.getElementById("live-status-text").textContent = "Super Bowl not found on today's schedule";
            document.getElementById("live-score-top").textContent = "--";
            document.getElementById("live-score-left").textContent = "--";
            document.getElementById("live-current-winner").textContent = "--";
            document.getElementById("live-current-winner").style.color = "";
        }
    } catch (err) {
        console.error("Live score fetch error:", err);
        document.getElementById("live-status-text").textContent = "Error: " + err.message;
    }
}

function findSuperBowl(data) {
    if (!data.events) return null;

    // Strategy 1: Look for event with "Super Bowl" in the name
    for (var i = 0; i < data.events.length; i++) {
        var ev = data.events[i];
        if (ev.name && ev.name.toLowerCase().indexOf("super bowl") !== -1) {
            return ev;
        }
        // Also check the notes/headline
        if (ev.competitions && ev.competitions[0] && ev.competitions[0].notes) {
            for (var n = 0; n < ev.competitions[0].notes.length; n++) {
                if (ev.competitions[0].notes[n].headline &&
                    ev.competitions[0].notes[n].headline.toLowerCase().indexOf("super bowl") !== -1) {
                    return ev;
                }
            }
        }
    }

    // Strategy 2: Look for our configured teams playing each other
    for (var i = 0; i < data.events.length; i++) {
        var ev = data.events[i];
        if (!ev.competitions || !ev.competitions[0]) continue;
        var comp = ev.competitions[0];
        var abbrs = comp.competitors.map(function(c) {
            return c.team.abbreviation.toUpperCase();
        });
        if (abbrs.indexOf(CONFIG.teamTopAbbr.toUpperCase()) !== -1 &&
            abbrs.indexOf(CONFIG.teamLeftAbbr.toUpperCase()) !== -1) {
            return ev;
        }
    }

    // Strategy 3: If only one game today, use it
    if (data.events.length === 1) return data.events[0];

    return null;
}

function updateLiveDisplay(event) {
    var comp   = event.competitions[0];
    var status = comp.status;

    // Find which competitor maps to our top/left teams
    var topComp  = null;
    var leftComp = null;
    for (var i = 0; i < comp.competitors.length; i++) {
        var c = comp.competitors[i];
        var abbr = c.team.abbreviation.toUpperCase();
        if (abbr === CONFIG.teamTopAbbr.toUpperCase()) topComp = c;
        if (abbr === CONFIG.teamLeftAbbr.toUpperCase()) leftComp = c;
    }

    // If teams don't match abbreviations, assign by home/away
    if (!topComp || !leftComp) {
        topComp  = comp.competitors[0];
        leftComp = comp.competitors[1];
        // Update display names
        document.getElementById("live-name-top").textContent  = topComp.team.abbreviation;
        document.getElementById("live-name-left").textContent = leftComp.team.abbreviation;
    } else {
        document.getElementById("live-name-top").textContent  = CONFIG.teamTopAbbr;
        document.getElementById("live-name-left").textContent = CONFIG.teamLeftAbbr;
    }

    var topScore  = parseInt(topComp.score, 10) || 0;
    var leftScore = parseInt(leftComp.score, 10) || 0;

    // Update score display
    document.getElementById("live-score-top").textContent  = topScore;
    document.getElementById("live-score-left").textContent = leftScore;
    document.getElementById("live-digit-top").textContent  = topScore % 10;
    document.getElementById("live-digit-left").textContent = leftScore % 10;

    // Game status
    var statusType = status.type.name;   // STATUS_SCHEDULED, STATUS_IN_PROGRESS, STATUS_END_PERIOD, STATUS_HALFTIME, STATUS_FINAL
    var period     = status.period || 0;
    var clock      = status.displayClock || "";

    var periodLabels = { 1: "Q1", 2: "Q2", 3: "Q3", 4: "Q4", 5: "OT" };
    var periodText = periodLabels[period] || ("Q" + period);

    // Update game time/date info
    var gameTimeEl = document.getElementById("live-game-time");
    if (event.date) {
        var gameDate = new Date(event.date);
        var dateStr = gameDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        var timeStr = gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZoneName: 'short' });
        gameTimeEl.textContent = dateStr + " at " + timeStr;
    } else {
        gameTimeEl.textContent = "";
    }

    // Update situation (possession, down, distance, etc.)
    var situationEl = document.getElementById("live-situation");
    var situationText = "";
    
    if (comp.situation) {
        var sit = comp.situation;
        if (sit.possession) {
            var possTeam = sit.possession === topComp.team.id ? CONFIG.teamTopAbbr : CONFIG.teamLeftAbbr;
            situationText = possTeam + " ball";
        }
        if (sit.downDistanceText) {
            situationText += (situationText ? ", " : "") + sit.downDistanceText;
        }
        if (sit.possessionText) {
            situationText += (situationText ? " at " : "") + sit.possessionText;
        }
    }
    
    // Add broadcasts info if available
    if (comp.broadcasts && comp.broadcasts.length > 0 && statusType === "STATUS_SCHEDULED") {
        var broadcastNames = comp.broadcasts.map(function(b) { return b.names ? b.names.join('/') : ''; }).filter(Boolean).join(', ');
        if (broadcastNames) {
            situationText = "Watch on: " + broadcastNames;
        }
    }

    situationEl.textContent = situationText;

    if (statusType === "STATUS_SCHEDULED") {
        document.getElementById("live-period").textContent = "PRE";
        document.getElementById("live-clock").textContent  = "";
        document.getElementById("live-status-text").textContent = status.type.shortDetail || "Game has not started";
        var badge = document.querySelector(".live-badge");
        if (badge) badge.textContent = "PREGAME";
    } else if (statusType === "STATUS_FINAL" || statusType === "STATUS_FINAL_OVERTIME") {
        document.getElementById("live-period").textContent = "FINAL";
        document.getElementById("live-clock").textContent  = "";
        document.getElementById("live-status-text").textContent = "Game Over";
        var badge = document.querySelector(".live-badge");
        if (badge) { badge.textContent = "FINAL"; badge.style.animation = "none"; badge.style.background = "#666"; }
    } else if (statusType === "STATUS_HALFTIME") {
        document.getElementById("live-period").textContent = "HALF";
        document.getElementById("live-clock").textContent  = "";
        document.getElementById("live-status-text").textContent = "Halftime";
    } else {
        document.getElementById("live-period").textContent = periodText;
        document.getElementById("live-clock").textContent  = clock;
        document.getElementById("live-status-text").textContent = status.type.detail || "Live";
        var badge = document.querySelector(".live-badge");
        if (badge) { badge.textContent = "LIVE"; badge.style.animation = ""; badge.style.background = ""; }
    }

    // Update live winner (no winner before game starts)
    lastLiveTopScore  = topScore;
    lastLiveLeftScore = leftScore;

    var winnerEl = document.getElementById("live-current-winner");
    if (statusType === "STATUS_SCHEDULED") {
        winnerEl.textContent = "--";
        winnerEl.style.color = "";
    } else {
        var result = lookupWinner(topScore, leftScore);
        if (result) {
            winnerEl.textContent = result.participant.name;
            winnerEl.style.color = result.participant.color;
        } else {
            winnerEl.textContent = "--";
            winnerEl.style.color = "";
        }
    }

    reapplyAllHighlights();

    // Auto-fill quarter scores from linescores when a quarter is complete
    autoFillQuarterScores(topComp, leftComp, period, statusType);

    // Highlight the active quarter card
    ["Q1","Q2","Q3","Final"].forEach(function(q) {
        var card = document.getElementById("card-" + q);
        if (card) card.classList.remove("q-active");
    });

    if (statusType === "STATUS_FINAL" || statusType === "STATUS_FINAL_OVERTIME") {
        var fc = document.getElementById("card-Final");
        if (fc) fc.classList.add("q-active");
    } else if (period >= 1 && period <= 4) {
        var qc = document.getElementById("card-Q" + period);
        if (qc) qc.classList.add("q-active");
    }

    // Update quarter winners in live scoreboard
    updateLiveQuarterWinners(topComp, leftComp, period, statusType);
}

function updateLiveQuarterWinners(topComp, leftComp, currentPeriod, statusType) {
    var topLines  = topComp.linescores  || [];
    var leftLines = leftComp.linescores || [];
    var qMap = ["Q1","Q2","Q3","Final"];
    var prizePool = CONFIG.pricePerSquare * 100 * 0.5;

    for (var q = 0; q < 4; q++) {
        var key = qMap[q];
        var itemEl   = document.getElementById("lqw-" + key);
        var nameEl   = document.getElementById("lqw-name-" + key);
        var scoreEl  = document.getElementById("lqw-score-" + key);
        var payoutEl = document.getElementById("lqw-payout-" + key);
        if (!itemEl || !nameEl || !scoreEl || !payoutEl) continue;

        var periodsNeeded = (q < 3) ? (q + 1) : topLines.length;

        // Determine if quarter is complete
        var isComplete = false;
        if (q < 3) {
            isComplete = currentPeriod > (q + 1) ||
                         statusType === "STATUS_FINAL" ||
                         statusType === "STATUS_FINAL_OVERTIME" ||
                         (statusType === "STATUS_HALFTIME" && q < 2);
        } else {
            isComplete = statusType === "STATUS_FINAL" || statusType === "STATUS_FINAL_OVERTIME";
        }

        // Determine if this is the current active quarter
        var isActive = false;
        if (q < 3) {
            isActive = currentPeriod === (q + 1) &&
                       statusType !== "STATUS_FINAL" &&
                       statusType !== "STATUS_FINAL_OVERTIME";
        } else {
            isActive = currentPeriod >= 4 &&
                       statusType !== "STATUS_FINAL" &&
                       statusType !== "STATUS_FINAL_OVERTIME";
        }

        // Reset classes
        itemEl.classList.remove("completed", "active");

        if (isComplete && topLines.length >= periodsNeeded && leftLines.length >= periodsNeeded) {
            // Compute cumulative score
            var topCum = 0, leftCum = 0;
            for (var p = 0; p < periodsNeeded; p++) {
                topCum  += parseFloat(topLines[p].value) || 0;
                leftCum += parseFloat(leftLines[p].value) || 0;
            }

            var result = lookupWinner(topCum, leftCum);
            var payout = Math.round(prizePool * CONFIG.payouts[key]);
            scoreEl.textContent = topCum + "-" + leftCum;

            if (result) {
                nameEl.textContent = result.participant.name;
                nameEl.style.color = result.participant.color;
            } else {
                nameEl.textContent = "--";
                nameEl.style.color = "";
            }

            payoutEl.textContent = "$" + payout.toLocaleString();
            itemEl.classList.add("completed");
        } else if (isActive) {
            nameEl.textContent = "In progress";
            nameEl.style.color = "";
            scoreEl.textContent = "";
            payoutEl.textContent = "";
            itemEl.classList.add("active");
        } else {
            nameEl.textContent = "--";
            nameEl.style.color = "";
            scoreEl.textContent = "";
            payoutEl.textContent = "";
        }
    }
}

function autoFillQuarterScores(topComp, leftComp, currentPeriod, statusType) {
    var topLines  = topComp.linescores  || [];
    var leftLines = leftComp.linescores || [];

    var qMap = ["Q1","Q2","Q3","Final"];

    // For each completed quarter, compute cumulative score and update display
    for (var q = 0; q < 4; q++) {
        var quarterKey = qMap[q];
        var periodsNeeded = (q < 3) ? (q + 1) : topLines.length; // Final = all periods

        // Check if this quarter is complete
        var isComplete = false;
        if (q < 3) {
            // Quarter q+1 is complete if currentPeriod > q+1, or game is final
            isComplete = currentPeriod > (q + 1) ||
                         statusType === "STATUS_FINAL" ||
                         statusType === "STATUS_FINAL_OVERTIME" ||
                         (statusType === "STATUS_HALFTIME" && q < 2);
        } else {
            // Final is complete only when game is over
            isComplete = statusType === "STATUS_FINAL" || statusType === "STATUS_FINAL_OVERTIME";
        }

        var topDisplay  = document.getElementById("score-display-top-" + quarterKey);
        var leftDisplay = document.getElementById("score-display-left-" + quarterKey);
        var winnerEl    = document.getElementById("winner-" + quarterKey);

        if (!isComplete) {
            // Reset if not complete
            if (topDisplay) topDisplay.textContent = "â€”";
            if (leftDisplay) leftDisplay.textContent = "â€”";
            if (winnerEl) winnerEl.textContent = "â€”";
            continue;
        }
        
        if (topLines.length < periodsNeeded || leftLines.length < periodsNeeded) continue;

        // Compute cumulative score through this quarter
        var topCum = 0, leftCum = 0;
        for (var p = 0; p < periodsNeeded; p++) {
            topCum  += parseFloat(topLines[p].value)  || 0;
            leftCum += parseFloat(leftLines[p].value) || 0;
        }

        // Update score displays
        if (topDisplay && leftDisplay) {
            topDisplay.textContent  = topCum;
            leftDisplay.textContent = leftCum;
            topDisplay.classList.add("filled");
            leftDisplay.classList.add("filled");
        }

        // Calculate and display winner
        var result = lookupWinner(topCum, leftCum);
        if (winnerEl) {
            if (result) {
                winnerEl.textContent = result.participant.name;
                winnerEl.style.color = result.participant.color;
            } else {
                winnerEl.textContent = "â€”";
                winnerEl.style.color = "";
            }
        }
    }
}

// ================================================================
// INIT
// ================================================================
function init() {
    var saved = loadState();

    if (saved && saved.locked) {
        currentSeed = saved.seed;
        isLocked = true;
    } else if (saved) {
        currentSeed = saved.seed;
        isLocked = false;
    }

    generateLayout(currentSeed);
    renderGrid();
    renderLegend();
    renderScoring();
    updateLockUI();

    // Scores are now populated from API only, no need to load from localStorage

    // Auto-start live score since live tab is default
    startLiveScore();
    
    // Auto-start chat if username is already set
    if (currentUsername && chatRef) {
        listenToMessages();
    }
}

init();
</script>
</body>
</html>
